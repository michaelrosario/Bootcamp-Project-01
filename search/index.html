<!DOCTYPE html>
<html>
  <head>
    <title>Search - Work Rimot</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
      
      * { 
            box-sizing: border-box;
        }
      .Logo { float: left; color: #FFF; width: 100%; margin: 16px 0 0 30px; max-width: 115px; }

      #map {
        margin-top: 62px;
        height: 100%;
        z-index: 1;
        width: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      header { 
        background: rgba(37,42,51,0.9);
        position: fixed; 
        top: 0px; 
        width: 100%;
        z-index: 1;
        height: 62px;
    }

        #search {
            float: right;
            border-radius: 5px;
            width: 50%; margin: 10px 15px 0 0;
            height: 40px; padding: 10px;
             font-size: 19px;
             z-index: 9999;
             position: relative;

        }
        
    
    
    </style>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAoNRzL9ESfNfTSMEGMsGNnM-a2a5PemIk&libraries=places&callback=initMap"
        async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  </head>
  <body>

   
    <header>
        <a class="Logo" href="/">
        <img src="../assets/images/rimote-logo.svg" alt="rimote-logo" id="rimotLogo" href="index.html">
        </a>
        <div class="search-container">
          <input id="search" type="text"
            placeholder="Enter a location">
        </div>
        
    </header>

    <div id="map"></div>
    
    <script>

    var map;
    var infowindow;
    var service;
    var loadedMarkers = [];
  
    function initMap() {
      
      var nyc = {
        lat: 40.7794406, 
        lng: -73.965438
      };
      
      var customMapTypeId = 'custom_style';

      var jsonStyle = [
          {
              "featureType": "water",
              "elementType": "geometry",
              "stylers": [
                  {
                      "color": "#e9e9e9"
                  },
                  {
                      "lightness": 17
                  }
              ]
          },
          {
              "featureType": "landscape",
              "elementType": "geometry",
              "stylers": [
                  {
                      "color": "#f5f5f5"
                  },
                  {
                      "lightness": 20
                  }
              ]
          },
          {
              "featureType": "road.highway",
              "elementType": "geometry.fill",
              "stylers": [
                  {
                      "color": "#ffffff"
                  },
                  {
                      "lightness": 17
                  }
              ]
          },
          {
              "featureType": "road.highway",
              "elementType": "geometry.stroke",
              "stylers": [
                  {
                      "color": "#ffffff"
                  },
                  {
                      "lightness": 29
                  },
                  {
                      "weight": 0.2
                  }
              ]
          },
          {
              "featureType": "road.arterial",
              "elementType": "geometry",
              "stylers": [
                  {
                      "color": "#ffffff"
                  },
                  {
                      "lightness": 18
                  }
              ]
          },
          {
              "featureType": "road.local",
              "elementType": "geometry",
              "stylers": [
                  {
                      "color": "#ffffff"
                  },
                  {
                      "lightness": 16
                  }
              ]
          },
          {
              "featureType": "poi",
              "elementType": "geometry",
              "stylers": [
                  {
                      "color": "#f5f5f5"
                  },
                  {
                      "lightness": 21
                  }
              ]
          },
          {
              "featureType": "poi.park",
              "elementType": "geometry",
              "stylers": [
                  {
                      "color": "#dedede"
                  },
                  {
                      "lightness": 21
                  }
              ]
          },
          {
              "elementType": "labels.text.stroke",
              "stylers": [
                  {
                      "visibility": "on"
                  },
                  {
                      "color": "#ffffff"
                  },
                  {
                      "lightness": 16
                  }
              ]
          },
          {
              "elementType": "labels.text.fill",
              "stylers": [
                  {
                      "saturation": 36
                  },
                  {
                      "color": "#333333"
                  },
                  {
                      "lightness": 40
                  }
              ]
          },
          {
              "elementType": "labels.icon",
              "stylers": [
                  {
                      "visibility": "off"
                  }
              ]
          },
          {
              "featureType": "transit",
              "elementType": "geometry",
              "stylers": [
                  {
                      "color": "#f2f2f2"
                  },
                  {
                      "lightness": 19
                  }
              ]
          },
          {
              "featureType": "administrative",
              "elementType": "geometry.fill",
              "stylers": [
                  {
                      "color": "#fefefe"
                  },
                  {
                      "lightness": 20
                  }
              ]
          },
          {
              "featureType": "administrative",
              "elementType": "geometry.stroke",
              "stylers": [
                  {
                      "color": "#fefefe"
                  },
                  {
                      "lightness": 17
                  },
                  {
                      "weight": 1.2
                  }
              ]
          }
      ];
      
      /* https://developers.google.com/maps/documentation/javascript/reference/ */
      map = new google.maps.Map(document.getElementById('map'), {
          zoom: 15,
          center:  nyc,
          disableDefaultUI: true,
          styles: jsonStyle,
      });

      //SEARCH
      var input = document.getElementById("search");
      var autocomplete = new google.maps.places.Autocomplete(input);
      autocomplete.bindTo('bounds', map);

      var marker = new google.maps.Marker({
          map: map,
          anchorPoint: new google.maps.Point(0, -29)
        });

      autocomplete.addListener('place_changed', function() {
        marker.setVisible(false);
        var place = autocomplete.getPlace();
        if (!place.geometry) {
            window.alert("No details available for input: '" + place.name + "'");
            return;
        }
          if (place.geometry.viewport) {
            map.fitBounds(place.geometry.viewport);
            console.log(place.geometry.viewport);
          } else {
            map.setCenter(place.geometry.location);
            console.log(place.geometry.location)
          }
          map.setZoom(15);
          searchArea({
            lat: place.geometry.location.lat(),
            lng: place.geometry.location.lng()
          });
          console.log('place',`/search/?lat=${place.geometry.location.lat()}&lang=${place.geometry.location.lng()}`);
          marker.setPosition(place.geometry.location);
          marker.setVisible(false);

      });
      
      // QUERY
      searchArea(nyc);

      map.addListener("center_changed", function() {
        searchArea(map.center);
      });
        

      //QUERY STRING
      var urlParams = new URLSearchParams(window.location.search);
      var lat = urlParams.get('lat');
      var lang = urlParams.get('lang');
      var zoom = urlParams.get('zoom') || 15;
      
      console.log(lat+" "+lang+" "+zoom);  

      if(lat && lang){
        newLocation(lat,lang,zoom);
      }

     
  }    

  function newLocation(newLat,newLng,newZoom){

    var center = new google.maps.LatLng(newLat, newLng);
  
    map.setZoom(parseInt(newZoom));
    map.panTo(center);      
  }
  var markers = [];
  function searchArea(place){
    var request = {
          location: place,
          keyword: 'coffee',
          radius: 1000,
        };
      infowindow = new google.maps.InfoWindow();

      service = new google.maps.places.PlacesService(map);

      service.nearbySearch(request, function(results, status) {
  
          if (status === google.maps.places.PlacesServiceStatus.OK) {
            for (var i = 0; i < results.length; i++) {
              if(!placeExists(results[i].id,loadedMarkers)){
                console.log(results[i]);
                loadedMarkers.push(results[i]);
                var position = { lat: results[i].geometry.location.lat(), lng: results[i].geometry.location.lng() };
                var marker = new google.maps.Marker({'position': position });
                var place = results[i];
                var activeInfoWindow;
                google.maps.event.addListener(marker, 'click', function() {
                    
                    console.log(JSON.stringify(place));
                    if (infowindow) {
                      infowindow.close();
                    }

                    if (activeInfoWindow) {
                      activeInfoWindow.close();
                    }

                    infowindow.setContent(`
                      <strong>${place.name}</strong> <br>
                      ${place.vicinity}<br>
                      ${place.rating ? `Rating: ${place.rating}` : ''} <br>
                      ${place.opening_hours && place.opening_hours.open_now ? `
                        Currently Open<br>
                        <a href="#" class="button check-in" data-id="${place.id}">Check In</a>`  : 'Currently Closed'}<br>
                      
                    `);
                    activeInfoWindow = infowindow;
                    infowindow.open(map, this);

                  });
                
                markers.push(marker);
                //createMarker(results[i]);
                //console.log(loadedMarkers);


              }
            }
          }

          var markerCluster = new MarkerClusterer(map, markers,
            {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});

      });
  }
  
  

// Check if id exists in our list already
function placeExists(placeId,arr) {
  return arr.some(function(el) {
    return el.id === placeId;
  }); 
}

    

      
      



    </script>

  
  </body>
</html>